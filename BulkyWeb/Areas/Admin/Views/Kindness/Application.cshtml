@model KindnessPosition
@using System.Text.Json
@{

    var builder = WebApplication.CreateBuilder();
    ViewBag.PublishDate = builder.Configuration.GetValue<string>("PublishDate");
    ViewData["Title"] = "財團法人台中市私立銀同碧湖陳氏社會福利基金會-祖先塔位暨牌位管理資訊系統（準預覽版本）";
    string? connectionString = builder.Configuration.GetConnectionString("DefaultConnection");

    // Auto logout settings
    float? AUTO_LOGOUT_MINUTE = builder.Configuration.GetSection("Logout_Duration:AUTO_LOGOUT_MINUTE").Get<float>();
    int? WARNING_BEFORE_LOGOUT_SECOND = builder.Configuration.GetSection("Logout_Duration:WARNING_BEFORE_LOGOUT_SECOND").Get<int>();

    // If AUTO_LOGOUT_MINUTE or WARNING_BEFORE_LOGOUT_SECOND is not set, use default values
    if (AUTO_LOGOUT_MINUTE == null || WARNING_BEFORE_LOGOUT_SECOND == null)
    {
        // Default values if not set in configuration
        AUTO_LOGOUT_MINUTE = (float?)0.5; // 30 minutes
        WARNING_BEFORE_LOGOUT_SECOND = 10; // 10 seconds
    }
    else
        // Set ViewBag for use in the view
        ViewBag.AUTO_LOGOUT_MINUTE = AUTO_LOGOUT_MINUTE;
    ViewBag.WARNING_BEFORE_LOGOUT_SECOND = WARNING_BEFORE_LOGOUT_SECOND;

    // Work_Duration is used for the duration of work in the system
    float? Work_Duration = builder.Configuration.GetSection("Work_Duration").Get<float>();
    int? WORK_WARNING_SECONDS = builder.Configuration.GetSection("WORK_WARNING_SECONDS").Get<int>();

    // If Work_Duration is not set, use default value
    if (Work_Duration == null)
    {
        // Default value if not set in configuration
        Work_Duration = (float?)1.0; // 1 mins
    }
    ViewBag.Work_Duration = Work_Duration;
    // Set ViewBag for WORK_WARNING_SECONDS for use in the view
    if (WORK_WARNING_SECONDS == null)
    {
        // Default value if not set in configuration
        WORK_WARNING_SECONDS = 60; // 60 seconds
    }
    ViewBag.WORK_WARNING_SECONDS = WORK_WARNING_SECONDS; // Default value will be null if not set
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 開頭設定CSS連結路徑 -->
    <link rel="stylesheet" href="~/css/position_Application.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/position_Display.css" asp-append-version="true" />
    <title>懷恩塔-祖先塔位設定</title>
</head>

<body>
    <header>
        <div id="txtblnk1" class="text-center fw-bolder blink">
            <p id="work_duration_top" style="font-size:larger;color:green;font-weight:bolder" class="text-bg-info align-content-center fw-bolder">@TempData["Success"]</p>
        </div>
    </header>
    <h1>作業功能:懷恩塔-祖先塔位設定</h1>
    <a asp-action="Index" class="btn btn-outline-primary bg-gradient mb-5 fw-semibold  text-uppercase">
        <label style="font-size:30px;color:darkgreen" text-dark-160>回上一頁</label>
    </a>
    <h3>一.塔位使用情形</h3>
    <div class="option-container">
        <table class="thlabel">
            <thead>
                <tr>
                    <th>  <label>塔位圖例</label></th>
                    <th>  <label>操作功能</label></th>
                    <th>  <label>空位統計</label></th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <table class="thlabel">
                            <tr>
                                <td>
                                    <div class="showcasePosition"></div>
                                    <label>空位</label>
                                </td>
                                <td>
                                    <div class="showcasePosition showcaseSelected"></div>
                                    <label>[新]選取</label>
                                </td>
                                <td>
                                    <div class="showcasePosition showcaseOccupied"></div>
                                    <label>使用中</label>
                                </td>
                                <td>
                                    <div class="showcasePosition showcaseCurrent"></div>
                                    <label>本次編輯</label>
                                </td>
                                <td>
                                    <div class="showcasePosition showcaseWindow_door"></div>
                                    <label>門 窗</label>
                                </td>

                            </tr>
                        </table>
                    </td>
                    <td>
                        <table class="thlabel">
                            <thead>
                                <tr>
                                    <th>
                                        <label>儲存設定資料</label>
                                    </th>
                                    <th>
                                        <label>設定結果</label>
                                    </th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>
                                        <button id="SubmitData" type="button" class="btn btn-primary" style="font-size:20px ;color:chartreuse">儲存</button>
                                    </td>
                                    <td>
                                        <p class="text">您已點選..<span id="fixedcount">0</span></p>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </td>
                    <td>
                        <label>總塔位:<span id="totalCount" class="text" style="font-size:40px ;color:blue">0</span></label>
                        <label>使用塔位:<span id="occupiedCount" class="text" style="font-size:40px ;color:red">0</span></label>
                        <label>空位:</label> <span id="notOccupiedCount" class="text" style="font-size:40px ;color:green">0</span>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <h3>二.祖先基本資料</h3>
    <div class="card-body p-4">
        <table id="tblData" class="table table-bordered table-striped fw-bolder thlabel" style="width:100%;text-align:center">
            <thead>
                <tr>
                    <th><label>祖先</label></th>
                    <th><label>樓</label></th>
                    <th><label>區</label></th>
                    <th><label>層</label></th>
                    <th><label>編號</label></th>
                    <th><label>塔位</label></th>
                    <th><label>申請人</label></th>
                    <th><label>關係</label></th>
                    <th><label>電話</label></th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>
                        <label class="displaylabel">@Model.Name</label>
                    </td>
                    <td>
                        <label>@Model.Floor</label>
                    </td>
                    <td>
                        <label>@Model.Section</label>
                    </td>
                    <td>
                        <label>@Model.Level</label>
                    </td>
                    <td>
                        <label>@Model.Position</label>
                    </td>
                    <td>
                        <label class="displaylabel">@Model.PositionId</label>
                    </td>
                    <td>
                        <label>@Model.Applicant</label>
                    </td>
                    <td>
                        <label>@Model.Relation</label>
                    </td>
                    <td>
                        <label>@Model.Mobile_Tel</label>
                    </td>
                </tr>
            </tbody>
        </table>
    </div>
    <h3>三.懷恩塔-祖先塔位圖區</h3>
    <div>
        <div id="RootDiv_Kindness" class="position-container"></div>
    </div>

    <div id="queryModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeQueryModal()">&times;</span>
            <h2>查詢條件</h2>
            <form id="queryForm">

                <label for="floor">樓層:</label>
                @*  <input type="text" id="floor" name="floor" class="form-control" /><br /> *@
                <select id="floor_select" class="form-select form-select-lg mb-3" style="font-size:20px " aria-label="Large select example">
                    <option value="0" selected>全部</option>
                    @for (int fi = 1; fi <= (ViewBag.KindnessFloor ?? 0); fi++)
                    {
                        <option value="@fi">@fi 樓</option>
                    }
                </select>

                @{
                    // Map section number to Chinese character
                    string[] sectionNames = { "甲", "乙", "丙", "丁", "戊", "己" };
                }

                <label for="section">區域(1:甲區,2:乙區,3:丙區,4:丁區,5:戊區,6:己區)</label>
                @*   <input type="text" id="section" name="section" class="form-control" /><br /> *@
                <select id="section_select" class="form-select form-select-lg mb-3" style="font-size:20px " aria-label="Large select example">
                    <option value="0" selected>全部</option>
                    @for (int seci = 1; seci <= (ViewBag.KindnessSection ?? 0); seci++)
                    {
                        var sectionLabel = seci <= sectionNames.Length ? sectionNames[seci - 1] : seci.ToString();
                        <option value="@sectionLabel">@sectionLabel 區</option>
                        @*  <option value="@seci">@seci 區</option> *@
                    }
                </select>
                <button type="button" onclick="applyFilters()" class="btn btn-success">套用篩選</button>
            </form>
        </div>
    </div>

    @* Yes/No modal *@
    <div id="yesNoModal" class="modal-overlay" style="display:none;">
        <span class="close-btn" onclick="closeYesNoModal()">&times;</span>
        <div class="modal-content yesno-modal">
            <h2 id="yesNoModalTitle" class="yesno-title">確定存檔</h2>
            @*       <p id="yesNoModalMessage" class="yesno-message">您確定要執行此操作嗎？</p *@
            <p id="yesNoModalMessage" class="yesno-message">確定存檔？</p>
            <div class="yesno-actions">
                <button type="button" class="btn btn-success yesno-btn" onclick="SubmitData()">是</button>
                <button type="button" class="btn btn-danger yesno-btn" onclick="yesNoModalNo()">否</button>
            </div>
        </div>
    </div>


    @* 2025 06 17 14:50
    To display the element
    <p class="text">您已點選<span id="count">0</span></p>
    as a floating tooltip that follows your mouse pointer,
    *@
    <p id="floatingCount" class="text" style="display:none; position:fixed; left:0; top:0; pointer-events:none; z-index:9999; background:rgba(255,255,255,0.95); border:1px solid #ccc; padding:4px 10px; border-radius:6px;">
        您已點選..<span id="floatedcount">0</span>
    </p>
    <div id="autoLogoutWarning">
        <div class="modal-content">
            <h4 style="color:#c0392b;">即將自動導到本會[問卷調查]....</h4>
            <p style="color:blue;font-size:larger;font-weight:bolder">您已經有一段時間沒有操作，將於 <span style="color:red;font-size:larger" id="logoutCountdown">@ViewBag.WARNING_BEFORE_LOGOUT_SECOND</span> 秒後自動導到本會[問卷調查](KA)。</p>
            <button onclick="stayLoggedIn()" class="btn btn-primary">[繼續使用]</button>
        </div>
    </div>
    <button id="goTopBtn" class="btn btn-danger">回到頂部</button>
    <div id="workDurationWarning" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
        <div class="modal-content" style="background:#fff; padding:2rem 2.5rem; border-radius:10px; box-shadow:0 4px 24px rgba(0,0,0,0.18); text-align:center; max-width:90vw;">
            <h2 style="color:lightpink">為資料安全,請於每次新增.修改.刪除資料後，請記得[務必]進行[備份資料]: 匯出EXCEL!! 以供保存!!</h2>
            <p style="color:blue;font-size:x-large;font-weight:bolder">您已經有一段時間沒有操作,您的連線將於 <span style="color:red;font-size:larger" id="workLogoutCountdown">@ViewBag.WORK_WARNING_SECONDS</span> 秒後結束，系統將導到[本會[問卷調查]](KA)。</p>
        </div>
    </div>
</body>
</html>

<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script>

        //用來儲存被選取的[塔位資訊]
        var displaytext;

        // 用來儲存被選取的[塔位編號]
        var selectedPositionInnerText;

        // 存檔按鈕
        const submitData = document.getElementById('SubmitData');

        //Returns the number of nodes in the collection.
        var selectedPositionsCount;

        // 抓取container的資料
        const position_container = document.querySelector('.position-container');
        // querySelctor: Returns the first element that is a descendant of node that matches selectors.
        //const positions = document.querySelectorAll('.position1f.position2f.position3f');
        const positions = document.querySelectorAll('.position');
        // querySelectorAll: Returns all element descendants of node that match selectors.

        //一.讀取各樓層塔位資料
        //1F 各區 塔位空格
        // 甲區
        // 取得甲區第1列的塔位編號
        var kf1arow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1arow1));
        // 取得甲區第2列的塔位編號
        var kf1arow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1arow2));
        // 取得甲區第3列的塔位編號
        var kf1arow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1arow3));
        // 取得甲區第4列的塔位編號
        var kf1arow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1arow4));

        // 乙區
         // 取得乙區第1列的塔位編號
         var kf1brow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1brow1));
         // 取得乙區第2列的塔位編號
         var kf1brow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1brow2));
         // 取得乙區第3列的塔位編號
         var kf1brow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1brow3));
         // 取得乙區第4列的塔位編號
         var kf1brow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1brow4));

        // 丙區
        // 取得丙區第1列的塔位編號
        var kf1crow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1crow1));
        // 取得丙區第2列的塔位編號
        var kf1crow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1crow2));
        // 取得丙區第3列的塔位編號
        var kf1crow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1crow3));
        // 取得丙區第4列的塔位編號
        var kf1crow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1crow4));

        // 丁區
        // 取得丁區第1列的塔位編號
        var kf1drow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1drow1));
        // 取得丁區第2列的塔位編號
        var kf1drow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1drow2));
        // 取得丁區第3列的塔位編號
        var kf1drow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1drow3));
        // 取得丁區第4列的塔位編號
        var kf1drow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1drow4));

        // 戊區
        // 取得戊區第1列的塔位編號
        var kf1erow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1erow1));
        // 取得戊區第2列的塔位編號
        var kf1erow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1erow2));
        // 取得戊區第3列的塔位編號
        var kf1erow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1erow3));
        // 取得戊區第4列的塔位編號
        var kf1erow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1erow4));

        // 己區
        // 取得己區第1列的塔位編號
        var kf1frow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1frow1));
        // 取得己區第2列的塔位編號
        var kf1frow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1frow2));
        // 取得己區第3列的塔位編號
        var kf1frow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1frow3));
        // 取得己區第4列的塔位編號
        var kf1frow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf1frow4));

        // 2F 各區 塔位空格
        //甲區
        // 取得甲區第1列的塔位編號
        var kf2arow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2arow1));
        // 取得甲區第2列的塔位編號
        var kf2arow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2arow2));
        // 取得甲區第3列的塔位編號
        var kf2arow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2arow3));
        // 取得甲區第4列的塔位編號
        var kf2arow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2arow4));

        // 乙區
        // 取得乙區第1列的塔位編號
        var kf2brow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2brow1));
        // 取得乙區第2列的塔位編號
        var kf2brow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2brow2));
        // 取得乙區第3列的塔位編號
        var kf2brow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2brow3));
        // 取得乙區第4列的塔位編號
        var kf2brow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2brow4));

        // 丙區
        // 取得丙區第1列的塔位編號
        var kf2crow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2crow1));
        // 取得丙區第2列的塔位編號
        var kf2crow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2crow2));
        // 取得丙區第3列的塔位編號
        var kf2crow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2crow3));
        // 取得丙區第4列的塔位編號
        var kf2crow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2crow4));

        // 丁區
        // 取得丁區第1列的塔位編號
        var kf2drow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2drow1));
        // 取得丁區第2列的塔位編號
        var kf2drow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2drow2));
        // 取得丁區第3列的塔位編號
        var kf2drow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2drow3));
        // 取得丁區第4列的塔位編號
        var kf2drow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2drow4));

        // 戊區
        // 取得戊區第1列的塔位編號
        var kf2erow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2erow1));
        // 取得戊區第2列的塔位編號
        var kf2erow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2erow2));
        // 取得戊區第3列的塔位編號
        var kf2erow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2erow3));
        // 取得戊區第4列的塔位編號
        var kf2erow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2erow4));

        // 己區
        // 取得己區第1列的塔位編號
        var kf2frow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2frow1));
        // 取得己區第2列的塔位編號
        var kf2frow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2frow2));
        // 取得己區第3列的塔位編號
        var kf2frow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2frow3));
        // 取得己區第4列的塔位編號
        var kf2frow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf2frow4));

        // 3F 各區 塔位空格
        // 甲區
        // 取得甲區第1列的塔位編號
        var kf3arow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3arow1));
        // 取得甲區第2列的塔位編號
        var kf3arow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3arow2));
        // 取得甲區第3列的塔位編號
        var kf3arow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3arow3));
        // 取得甲區第4列的塔位編號
        var kf3arow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3arow4));
        // 取得甲區第5列的塔位編號
        var kf3arow5 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3arow5));
        // 取得甲區第6列的塔位編號
        var kf3arow6 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3arow6));
        // 取得甲區第7列的塔位編號
        var kf3arow7 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3arow7));

        // 乙區
        // 取得乙區第1列的塔位編號
        var kf3brow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3brow1));
        // 取得乙區第2列的塔位編號
        var kf3brow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3brow2));
        // 取得乙區第3列的塔位編號
        var kf3brow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3brow3));
        // 取得乙區第4列的塔位編號
        var kf3brow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3brow4));
        // 取得乙區第5列的塔位編號
        var kf3brow5 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3brow5));
        // 取得乙區第6列的塔位編號
        var kf3brow6 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3brow6));
        // 取得乙區第7列的塔位編號
        var kf3brow7 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3brow7));

        // 丙區
        // 取得丙區第1列的塔位編號
        var kf3crow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3crow1));
        // 取得丙區第2列的塔位編號
        var kf3crow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3crow2));
        // 取得丙區第3列的塔位編號
        var kf3crow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3crow3));
        // 取得丙區第4列的塔位編號
        var kf3crow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3crow4));
        // 取得丙區第5列的塔位編號
        var kf3crow5 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3crow5));
        // 取得丙區第6列的塔位編號
        var kf3crow6 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3crow6));
        // 取得丙區第7列的塔位編號
        var kf3crow7 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3crow7));

        // 丁區
        // 取得丁區第1列的塔位編號
        var kf3drow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3drow1));
        // 取得丁區第2列的塔位編號
        var kf3drow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3drow2));
        // 取得丁區第3列的塔位編號
        var kf3drow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3drow3));
        // 取得丁區第4列的塔位編號
        var kf3drow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3drow4));
        // 取得丁區第5列的塔位編號
        var kf3drow5 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3drow5));
        // 取得丁區第6列的塔位編號
        var kf3drow6 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3drow6));
        // 取得丁區第7列的塔位編號
        var kf3drow7 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3drow7));

        // 戊區
        // 取得戊區第1列的塔位編號
        var kf3erow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3erow1));
        // 取得戊區第2列的塔位編號
        var kf3erow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3erow2));
        // 取得戊區第3列的塔位編號
        var kf3erow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3erow3));
        // 取得戊區第4列的塔位編號
        var kf3erow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3erow4));
        // 取得戊區第5列的塔位編號
        var kf3erow5 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3erow5));
        // 取得戊區第6列的塔位編號
        var kf3erow6 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3erow6));
        // 取得戊區第7列的塔位編號
        var kf3erow7 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3erow7));

        // 己區
        // 取得己區第1列的塔位編號
        var kf3frow1 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3frow1));
        // 取得己區第2列的塔位編號
        var kf3frow2 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3frow2));
        // 取得己區第3列的塔位編號
        var kf3frow3 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3frow3));
        // 取得己區第4列的塔位編號
        var kf3frow4 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3frow4));
        // 取得己區第5列的塔位編號
        var kf3frow5 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3frow5));
        // 取得己區第6列的塔位編號
        var kf3frow6 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3frow6));
        // 取得己區第7列的塔位編號
        var kf3frow7 = @Html.Raw(JsonSerializer.Serialize(ViewBag.kf3frow7));

        //////////////////////////////
        // 二.建立各樓層塔位資料陣列
        /////////////////////////////

        //甲區
                var positionary_kf1a = Array.from({ length: @(ViewBag.kf1ar ?? 0) }, () => Array(@(ViewBag.kf1ac ?? 0)).fill(0));
        // 取得甲區第1列的塔位編號
        positionary_kf1a[0] = kf1arow1.split(",");
        // 取得甲區第2列的塔位編號
        positionary_kf1a[1] = kf1arow2.split(",");
        // 取得甲區第3列的塔位編號
        positionary_kf1a[2] = kf1arow3.split(",");
        // 取得甲區第4列的塔位編號
        positionary_kf1a[3] = kf1arow4.split(",");
          //乙區
                  var positionary_kf1b = Array.from({ length: @ViewBag.kf1br }, () => Array(@ViewBag.kf1bc).fill(0));
        // 取得乙區第1列的塔位編號
        positionary_kf1b[0] = kf1brow1.split(",");
        // 取得乙區第2列的塔位編號
        positionary_kf1b[1] = kf1brow2.split(",");
        // 取得乙區第3列的塔位編號
        positionary_kf1b[2] = kf1brow3.split(",");
        // 取得乙區第4列的塔位編號
        positionary_kf1b[3] = kf1brow4.split(",");
          //丙區
                  var positionary_kf1c = Array.from({ length: @ViewBag.kf1cr }, () => Array(@ViewBag.kf1cc).fill(0));
        // 取得丙區第1列的塔位編號
        positionary_kf1c[0] = kf1crow1.split(",");
        // 取得丙區第2列的塔位編號
        positionary_kf1c[1] = kf1crow2.split(",");
        // 取得丙區第3列的塔位編號
        positionary_kf1c[2] = kf1crow3.split(",");
        // 取得丙區第4列的塔位編號
        positionary_kf1c[3] = kf1crow4.split(",");
          //丁區
                  var positionary_kf1d = Array.from({ length: @ViewBag.kf1dr }, () => Array(@ViewBag.kf1dc).fill(0));
        // 取得丁區第1列的塔位編號
        positionary_kf1d[0] = kf1drow1.split(",");
        // 取得丁區第2列的塔位編號
        positionary_kf1d[1] = kf1drow2.split(",");
        // 取得丁區第3列的塔位編號
        positionary_kf1d[2] = kf1drow3.split(",");
        // 取得丁區第4列的塔位編號
        positionary_kf1d[3] = kf1drow4.split(",");
          //戊區
              var positionary_kf1e = Array.from({ length: @ViewBag.kf1er }, () => Array(@ViewBag.kf1ec).fill(0));
        // 取得戊區第1列的塔位編號
        positionary_kf1e[0] = kf1erow1.split(",");
        // 取得戊區第2列的塔位編號
        positionary_kf1e[1] = kf1erow2.split(",");
        // 取得戊區第3列的塔位編號
        positionary_kf1e[2] = kf1erow3.split(",");
        // 取得戊區第4列的塔位編號
        positionary_kf1e[3] = kf1erow4.split(",");
           //己區
              var positionary_kf1f = Array.from({ length: @ViewBag.kf1fr }, () => Array(@ViewBag.kf1fc).fill(0));
        // 取得己區第1列的塔位編號
        positionary_kf1f[0] = kf1frow1.split(",");
        // 取得己區第2列的塔位編號
        positionary_kf1f[1] = kf1frow2.split(",");
        // 取得己區第3列的塔位編號
        positionary_kf1f[2] = kf1frow3.split(",");
        // 取得己區第4列的塔位編號
        positionary_kf1f[3] = kf1frow4.split(",");


           //2F 各區 塔位空格
          //甲區
                  var positionary_kf2a = Array.from({ length: @ViewBag.kf2ar }, () => Array(@ViewBag.kf2ac).fill(0));
          // 取得甲區第1列的塔位編號
          positionary_kf2a[0] = kf2arow1.split(",");
          // 取得甲區第2列的塔位編號
          positionary_kf2a[1] = kf2arow2.split(",");
          // 取得甲區第3列的塔位編號
          positionary_kf2a[2] = kf2arow3.split(",");
          // 取得甲區第4列的塔位編號
          positionary_kf2a[3] = kf2arow4.split(",");
          //乙區
                  var positionary_kf2b = Array.from({ length: @ViewBag.kf2br }, () => Array(@ViewBag.kf2bc).fill(0));
            // 取得乙區第1列的塔位編號
            positionary_kf2b[0] = kf2brow1.split(",");
            // 取得乙區第2列的塔位編號
            positionary_kf2b[1] = kf2brow2.split(",");
            // 取得乙區第3列的塔位編號
            positionary_kf2b[2] = kf2brow3.split(",");
            // 取得乙區第4列的塔位編號
            positionary_kf2b[3] = kf2brow4.split(",");
          //丙區
                  var positionary_kf2c = Array.from({ length: @ViewBag.kf2cr }, () => Array(@ViewBag.kf2cc).fill(0));
            // 取得丙區第1列的塔位編號
            positionary_kf2c[0] = kf2crow1.split(",");
            // 取得丙區第2列的塔位編號
            positionary_kf2c[1] = kf2crow2.split(",");
            // 取得丙區第3列的塔位編號
            positionary_kf2c[2] = kf2crow3.split(",");
            // 取得丙區第4列的塔位編號
            positionary_kf2c[3] = kf2crow4.split(",");
          //丁區
                  var positionary_kf2d = Array.from({ length: @ViewBag.kf2dr }, () => Array(@ViewBag.kf2dc).fill(0));
            // 取得丁區第1列的塔位編號
            positionary_kf2d[0] = kf2drow1.split(",");
            // 取得丁區第2列的塔位編號
            positionary_kf2d[1] = kf2drow2.split(",");
            // 取得丁區第3列的塔位編號
            positionary_kf2d[2] = kf2drow3.split(",");
            // 取得丁區第4列的塔位編號
            positionary_kf2d[3] = kf2drow4.split(",");
          //戊區
                  var positionary_kf2e = Array.from({ length: @ViewBag.kf2er }, () => Array(@ViewBag.kf2ec).fill(0));
            // 取得戊區第1列的塔位編號
            positionary_kf2e[0] = kf2erow1.split(",");
            // 取得戊區第2列的塔位編號
            positionary_kf2e[1] = kf2erow2.split(",");
            // 取得戊區第3列的塔位編號
            positionary_kf2e[2] = kf2erow3.split(",");
            // 取得戊區第4列的塔位編號
            positionary_kf2e[3] = kf2erow4.split(",");
          //己區
                  var positionary_kf2f = Array.from({ length: @ViewBag.kf2fr }, () => Array(@ViewBag.kf2fc).fill(0));
            // 取得己區第1列的塔位編號
            positionary_kf2f[0] = kf2frow1.split(",");
            // 取得己區第2列的塔位編號
            positionary_kf2f[1] = kf2frow2.split(",");
            // 取得己區第3列的塔位編號
            positionary_kf2f[2] = kf2frow3.split(",");
            // 取得己區第4列的塔位編號
            positionary_kf2f[3] = kf2frow4.split(",");

           //3F  各區 塔位空格
          //甲區
                  var positionary_kf3a = Array.from({ length: @ViewBag.kf3ar }, () => Array(@ViewBag.kf3ac).fill(0));
            // 取得甲區第1列的塔位編號
            positionary_kf3a[0] = kf3arow1.split(",");
            // 取得甲區第2列的塔位編號
            positionary_kf3a[1] = kf3arow2.split(",");
            // 取得甲區第3列的塔位編號
            positionary_kf3a[2] = kf3arow3.split(",");
            // 取得甲區第4列的塔位編號
            positionary_kf3a[3] = kf3arow4.split(",");
            // 取得甲區第5列的塔位編號
            positionary_kf3a[4] = kf3arow5.split(",");
            // 取得甲區第6列的塔位編號
            positionary_kf3a[5] = kf3arow6.split(",");
            // 取得甲區第7列的塔位編號
            positionary_kf3a[6] = kf3arow7.split(",");
          //乙區
                  var positionary_kf3b = Array.from({ length: @ViewBag.kf3br }, () => Array(@ViewBag.kf3bc).fill(0));
            // 取得乙區第1列的塔位編號
            positionary_kf3b[0] = kf3brow1.split(",");
            // 取得乙區第2列的塔位編號
            positionary_kf3b[1] = kf3brow2.split(",");
            // 取得乙區第3列的塔位編號
            positionary_kf3b[2] = kf3brow3.split(",");
            // 取得乙區第4列的塔位編號
            positionary_kf3b[3] = kf3brow4.split(",");
            // 取得乙區第5列的塔位編號
            positionary_kf3b[4] = kf3brow5.split(",");
            // 取得乙區第6列的塔位編號
            positionary_kf3b[5] = kf3brow6.split(",");
            // 取得乙區第7列的塔位編號
            positionary_kf3b[6] = kf3brow7.split(",");
          //丙區
                  var positionary_kf3c = Array.from({ length: @ViewBag.kf3cr }, () => Array(@ViewBag.kf3cc).fill(0));
            // 取得丙區第1列的塔位編號
            positionary_kf3c[0] = kf3crow1.split(",");
            // 取得丙區第2列的塔位編號
            positionary_kf3c[1] = kf3crow2.split(",");
            // 取得丙區第3列的塔位編號
            positionary_kf3c[2] = kf3crow3.split(",");
            // 取得丙區第4列的塔位編號
            positionary_kf3c[3] = kf3crow4.split(",");
            // 取得丙區第5列的塔位編號
            positionary_kf3c[4] = kf3crow5.split(",");
            // 取得丙區第6列的塔位編號
            positionary_kf3c[5] = kf3crow6.split(",");
            // 取得丙區第7列的塔位編號
            positionary_kf3c[6] = kf3crow7.split(",");
          //丁區
                  var positionary_kf3d = Array.from({ length: @ViewBag.kf3dr }, () => Array(@ViewBag.kf3dc).fill(0));
            // 取得丁區第1列的塔位編號
            positionary_kf3d[0] = kf3drow1.split(",");
            // 取得丁區第2列的塔位編號
            positionary_kf3d[1] = kf3drow2.split(",");
            // 取得丁區第3列的塔位編號
            positionary_kf3d[2] = kf3drow3.split(",");
            // 取得丁區第4列的塔位編號
            positionary_kf3d[3] = kf3drow4.split(",");
            // 取得丁區第5列的塔位編號
            positionary_kf3d[4] = kf3drow5.split(",");
            // 取得丁區第6列的塔位編號
            positionary_kf3d[5] = kf3drow6.split(",");
            // 取得丁區第7列的塔位編號
            positionary_kf3d[6] = kf3drow7.split(",");
          //戊區
                  var positionary_kf3e = Array.from({ length: @ViewBag.kf3er }, () => Array(@ViewBag.kf3ec).fill(0));
            // 取得戊區第1列的塔位編號
            positionary_kf3e[0] = kf3erow1.split(",");
            // 取得戊區第2列的塔位編號
            positionary_kf3e[1] = kf3erow2.split(",");
            // 取得戊區第3列的塔位編號
            positionary_kf3e[2] = kf3erow3.split(",");
            // 取得戊區第4列的塔位編號
            positionary_kf3e[3] = kf3erow4.split(",");
            // 取得戊區第5列的塔位編號
            positionary_kf3e[4] = kf3erow5.split(",");
            // 取得戊區第6列的塔位編號
            positionary_kf3e[5] = kf3erow6.split(",");
            // 取得戊區第7列的塔位編號
            positionary_kf3e[6] = kf3erow7.split(",");
          //己區
                  var positionary_kf3f = Array.from({ length: @ViewBag.kf3fr }, () => Array(@ViewBag.kf3fc).fill(0));
            // 取得己區第1列的塔位編號
            positionary_kf3f[0] = kf3frow1.split(",");
            // 取得己區第2列的塔位編號
            positionary_kf3f[1] = kf3frow2.split(",");
            // 取得己區第3列的塔位編號
            positionary_kf3f[2] = kf3frow3.split(",");
            // 取得己區第4列的塔位編號
            positionary_kf3f[3] = kf3frow4.split(",");
            // 取得己區第5列的塔位編號
            positionary_kf3f[4] = kf3frow5.split(",");
            // 取得己區第6列的塔位編號
            positionary_kf3f[5] = kf3frow6.split(",");
            // 取得己區第7列的塔位編號
            positionary_kf3f[6] = kf3frow7.split(",");

            ////////////////////////////
            //三.顯示塔位圖
            ///////////////////////////

             //3樓
            // 顯示3樓甲區塔位:
            var desc="3樓-甲區-";
            renderPositionRows(positionary_kf3a,desc,'level3f','position');
            // 顯示3樓乙區塔位:
             desc="3樓-乙區-";
            renderPositionRows(positionary_kf3b,desc,'level3f','position');
            // 顯示3樓丙區塔位:
             desc="3樓-丙區-";
            renderPositionRows(positionary_kf3c,desc,'level3f','position');
            // 顯示3樓丁區塔位:
             desc="3樓-丁區-";
            renderPositionRows(positionary_kf3d,desc,'level3f','position');
            // 顯示3樓戊區塔位:
             desc="3樓-戊區-";
            renderPositionRows(positionary_kf3e,desc,'level3f','position');
            // 顯示3樓己區塔位:
             desc="3樓-己區-";
            renderPositionRows(positionary_kf3f,desc,'level3f','position');


             //2樓:
            // 顯示2樓甲區塔位:
             desc="2樓-甲區-";
            renderPositionRows(positionary_kf2a,desc,'level2f','position');
            // 顯示2樓乙區塔位:
             desc="2樓-乙區-";
            renderPositionRows(positionary_kf2b,desc,'level2f','position');
            // 顯示2樓丙區塔位:
             desc="2樓-丙區-";
            renderPositionRows(positionary_kf2c,desc,'level2f','position');
            // 顯示2樓丁區塔位:
             desc="2樓-丁區-";
            renderPositionRows(positionary_kf2d,desc,'level2f','position');
            // 顯示2樓戊區塔位:
             desc="2樓-戊區-";
            renderPositionRows(positionary_kf2e,desc,'level2f','position');
            // 顯示2樓己區塔位:
             desc="2樓-己區-";
            renderPositionRows(positionary_kf2f,desc,'level2f','position');

            //1樓:
            // 顯示1樓甲區塔位:
            desc="1樓-甲區-";
            renderPositionRows(positionary_kf1a,desc,'level1f','position');
            // 顯示1樓乙區塔位:
            desc="1樓-乙區-";
            renderPositionRows(positionary_kf1b,desc,'level1f','position');
            // 顯示1樓丙區塔位:
            desc="1樓-丙區-";
            renderPositionRows(positionary_kf1c,desc,'level1f','position');
            // 顯示1樓丁區塔位:
            desc="1樓-丁區-";
            renderPositionRows(positionary_kf1d,desc,'level1f','position');
            // 顯示1樓戊區塔位:
            desc="1樓-戊區-";
            renderPositionRows(positionary_kf1e,desc,'level1f','position');
            // 顯示1樓己區塔位:
            desc="1樓-己區-";
            renderPositionRows(positionary_kf1f,desc,'level1f','position');

            // 功能:這個函數用來渲染懷恩塔的塔位圖(顯示各樓層塔位圖)
            // 參數:positionary_kfloorary 各樓層塔位資料
         function renderPositionRows(positionary_kfloorary,desc,levelClassName,postionClassName) {
            //Get each Row ID
            let rowId = "";
            for (let i = positionary_kfloorary.length -1 ; i >= 0 ; i--) {
                //Get each Row ID
                rowId = (i+1)
                // Get each row of position IDs
                // 取得每一列的塔位編號
                let row = positionary_kfloorary[i];
                // Create a div for the row
                // 創建一個div元素來表示這一列
                let rowDiv = document.createElement('div');
                // 設定class為row
                rowDiv.className = 'row';
                for (let j = 0; j < row.length; j++) {
                    // Get each position ID
                    // 取得每一個塔位編號
                    let position=row[j]; //塔位編號
                    let positionId = desc+rowId+"層:" + position;  //eg:1樓-己區-7:34  format:樓-區-層:位
                    // Create a span for the position
                    // 創建一個span元素來表示這個塔位
                    let positionSpan = document.createElement('span');
                    positionSpan.readOnly = true //關閉點選
                    if (position==="000")
                    {
                           positionSpan.className = 'position_window_door'; // 門/窗位置,要跳開
                           positionSpan.innerText = '通氣窗-出入口';   // 內容:設定'門/窗位置,請略過'
                    }
                    else
                    {
                           positionSpan.className = postionClassName; // 設定class為可用的position
                           positionSpan.innerText = positionId; // 設定文字內容為塔位編號
                    }

                    // Add the span to the row div
                    // 將這個span元素添加到rowDiv中
                    rowDiv.appendChild(positionSpan);
                }
                // 創建一個span元素來表示這個塔區說明 desc
                    let positionSpan = document.createElement('span');
                    positionSpan.readOnly = true //關閉點選
                    positionSpan.className = levelClassName; // 設定class為classname
                    positionSpan.innerText = desc +(i+1)+"層"; // 設定文字內容為塔位編號
                     // Add the span to the row div
                    // 將這個span元素添加到rowDiv中
                    rowDiv.appendChild(positionSpan);
                // Add the row div to the container
                // 將這一列的div添加到RootDiv_Kindness中
                document.getElementById('RootDiv_Kindness').appendChild(rowDiv);
            }
        }

         /////////////////////////////
         //四.動態查詢1
         //  Q3: 2025 06 17(Tue) 10:34
         //  how to create a 'click event' with a funtion key 'f1' OR 'Q' 'q'?
         //  ===========================================================

        // How it works:
        // •	Listens for any keydown event.
        // •	Checks if the key is F1.
        // •	Prevents the default browser help.
        // •	Calls your modal-opening function.
        // This will allow users to open your modal by pressing the F1 key anywhere on the page.
         ////////////////////////////
         // document.addEventListener('keydown', function (e) {
         //    if (e.key === 'F1' || e.key === 'Q' ||e.key === 'q') {
         //    e.preventDefault(); // Prevent browser help
         //    openQueryModal();   // Call your function
         // }
         // });

            // How it works:
         // •	Listens for any keydown event.
         // •	Checks if the key is F1.
         // •	Prevents the default browser help.
         // •	Calls your modal-opening function.
         // This will allow users to open your modal by pressing the F1 key anywhere on the page.
          ////////////////////////////
          // document.addEventListener('keydown', function (e) {
          //  if (e.key === 'S' || e.key === 's') {
          //    e.preventDefault(); // Prevent browser help
          //            openYesNoModal();   // Call your function openYesNoModal()
          // }
          // });

        /////////////////////////////
        //四.動態查詢2
        // To create a floating querying modal in your Razor Pages project,
        //  you can use a combination of HTML, CSS, and JavaScript.
        //  Here’s a simple, reusable approach:
        //  1. Add the Modal HTML
        //          Place this just before your closing </body> tag:
        //  2. Add the Modal CSS
        //          Add this to your <head> or your CSS file:
        //  3. Add the Modal JavaScript
        //          Add this at the end of your <script> section:
        //  Summary:
        //      This will create a floating modal for querying,
        //      which you can expand with more fields or logic as needed.
        //      The modal is hidden by default and appears centered when triggered.
        //      You can style and extend it further to fit your requirements.
        ////////////////////////////

            function openQueryModal() {
                document.getElementById('queryModal').style.display = 'flex';
            }
            function closeQueryModal() {
                document.getElementById('queryModal').style.display = 'none';
            }
            function submitQuery() {
                // Example: get values and do something
                var floor = document.getElementById('floor_select').value;
                var section = document.getElementById('section_select').value;
                // TODO: Add your query logic here
                ExecuteQuery(floor,section);
                //alert('查詢: 樓層=' + floor + ', 區域=' + section);
                closeQueryModal();
            }


          //(1)使用addEventListener來追蹤position_container內每個點選動作
          //   目標為position_container
          position_container.addEventListener('click', e =>{
                //Ensure the click is on a .position element, not a child
                //const positionDiv = e.target.closest('.position1f.position2f.position3f');
                const positionDiv = e.target.closest('.position');

                    if (!positionDiv || positionDiv.classList.contains('occupied')
                         || positionDiv.classList.contains('level1f')
                         || positionDiv.classList.contains('level2f')
                         || positionDiv.classList.contains('level3f')
                         || positionDiv.classList.contains('window_door'))
                    return;

                    // If already selected, deselect
                    if (positionDiv.classList.contains('selected')) {
                        positionDiv.classList.remove('selected');
                        selectedPositionInnerText = '';
                        updateSelectedCount();
                        //顯示塔位使用情形(空位資訊)
                        updatePositionCounts(); // Add this line
                        return;
                    }

                    // Deselect any previously selected position
                    //const prevSelected = document.querySelector('.position1f.position2f.position3f.selected
                    const prevSelected = document.querySelector('.position.selected');
                    if (prevSelected) {
                        prevSelected.classList.remove('selected');
                    }

                    // Select the new position
                    positionDiv.classList.add('selected');
                    //選取的塔位資訊
                    selectedPositionInnerText = positionDiv.innerText;
                    updateSelectedCount();
                    //顯示塔位使用情形(空位資訊)
                    updatePositionCounts(); // Add this line



             });

           //(2)Update total and Count
           function updateSelectedCount() {
            //注意: .row .seat.selected 不等於 .row.seat.selected
            // .row .seat.selected 代表<div>row下面的class "seat selected"

             const selectedPositionList = document.querySelectorAll('.selected');
                   selectedPositionsCount = selectedPositionList.length;
                   //document.getElementById('count').innerText = selectedPositionsCount;

              // Copy selected seats into arr
              // Map through aray
              // Return a new array indexes
              // 使用...可以把多個目標內的內容依次選取完成
              // 使用map可以用來傳遞陣列
              // 被選取的座位會回傳以陣列所屬的index
              //alert('selectedPositionList.length: '+ selectedPositionList.length);
              const positionsIndex = [...selectedPositionList].map(position => [...positions].indexOf(position));
               if(positionsIndex.length>0)
               {
                 localStorage.setItem('KindessselectedPositionList', JSON.stringify(positionsIndex));
               }

              //使用Length回傳所選取的座位數量
              //Returns the number of nodes in the collection.
              selectedPositionsCount = selectedPositionList.length;
              if (selectedPositionsCount > 0)
              {
                   // 把選取的座位資訊，反應在Mouse頂端
                   displaytext=selectedPositionInnerText;
                   fixedcount.innerText = displaytext;
                   floatedcount.innerText = displaytext;
               }
               else
               {
                   selectedPositionsCount = 0;
                   // 把選取的座位資訊，反應在Mouse頂端
                   displaytext=selectedPositionInnerText;
                   fixedcount.innerText = displaytext;
                   floatedcount.innerText = displaytext;
               }

          }
          ///////////////////動態條件查詢

         //(1) populate position from Database to UI
        function populateUI() {

            const positions = document.querySelectorAll('.position');
            //alert('positions.length: '+positions.length);

                //已進駐祖先的塔位清單儲入 ViewBag.ListPositionId
            var listPositionId = @Html.Raw(JsonSerializer.Serialize(ViewBag.ListPositionId));
            //alert('listPositionId.length: '+listPositionId.length);
                if(listPositionId.length > 0) {
                    //alert('kind==1');
                    //alert('ListPositionId: ' + JSON.stringify(listPositionId));
                    positions.forEach(position => {
                        listPositionId.forEach(positionid => {  //位置編號 //positionid  eg: '1樓-甲區-7層-234,陳公1'
                        var  Local_positionid=position.innerText;
                        //alert('Local_positionid: ' +Local_positionid);//位置內容 eg: '1樓-甲區-7層-234'
                        var  positionId_compared=positionid.substr(0,positionid.indexOf(","));  // 取得逗號[前]的文字:編號
                        //alert('positionId_compared: ' +positionId_compared);
                        var  name=positionid.substr(positionid.indexOf(",")+1);  // 取得逗號[後]的文字:祖先名諱
                        //alert('name: ' +name);
                        var  bool_result=positionId_compared===Local_positionid;//找到 ===編號
                        //alert('bool_result: ' +bool_result);
                          //目前查詢的塔位
                        var currentPositonId=  @Html.Raw(JsonSerializer.Serialize(ViewBag.PositionId));
                        if (bool_result) {
                            position.classList.add('occupied');//已使用塔位用灰色
                            position.innerText += ('-'+ name);
                                 if (currentPositonId === Local_positionid) //目前查詢的塔位
                              {
                                 position.classList.add('current');//目前查詢的塔位用 淡青色
                                 position.classList.add('blink');//  目前查詢的牌位 閃爍 2025 08 28 09:40
                                 var  sideSectionLevel=positionid.substr(0,positionid.indexOf(":"));  // 取得[:][前]的文字:側邊-區號-層數
                                 //alert('sideSectionLevel'+sideSectionLevel);
                                 var targetSpan = findSpanByInnerText(sideSectionLevel);
                                     if (targetSpan) {
                                         targetSpan.classList.add('blink');// 閃爍 目前查詢的牌位之'側邊-區號-層數' 2025 08 28 09:57
                                    }
                              }
                            }
                        });
                    });
                }
       }

       function findSpanByInnerText(sideSectionLevel) {
        // 2025 08 01 00:18 Get all spans (or use a more specific selector if needed)
        const spans = document.querySelectorAll('span');
        // Find the first span whose innerText matches floorSectionLevel exactly
        for (let span of spans) {
            if (span.innerText.trim() === sideSectionLevel.trim()) {
                return span;
            }
        }
        return null; // Not found
       }
        //----------------------------------------------------------------------------------------------
        //(1)To save data from localStorage into your database in a Razor Pages project, follow these steps:
        // 2025 05 24 09:13
        // (1) JSON.stringify() ：物件變 JSON
        // json 會儲存純文字，不算是一種 Javascript，但是 Javascipt 有內建的方法可以解析他，
        // 其中將任何物件轉變為 JSON 字串的方法，就是 JSON.stringify() ，string 本身就是字串的意思，
        // stringify 則視為動詞字串化，將 Javascript 物件轉為 JSON 字串。
        //
        // (2) JSON.parse()：JSON 變物件
        //JSON.parse() 則相反，可以接收 JSON 字串，轉為 Javascript 物件或是值。
        //----------------------------------------------------------------------------------------------
             // Get data from localStorage
             function SubmitData()
             {
                   //alert('function submitQueryCon: floor:'+floor+' section:'+section);
                   //JavaScript (client-side)
                   //const selectedPositions = [1, 2, 3, 4];
                   //const selectedPositions = JSON.parse(localStorage.getItem('KindnessSelectedPositionList'));
                   //alert('selectedPositions: '+ selectedPositions);
                   if (selectedPositionInnerText == "" || selectedPositionInnerText == null) {
                       alert('請先選擇塔位！');
                       return;
                   }
                   else
                   {
                       fetch('/Admin/Kindness/SavePositions', {
                       method: 'POST',
                       headers: {
                       'Content-Type': 'application/json'
                       },
                       body: JSON.stringify(selectedPositionInnerText) //被選取的[塔位資訊]
                       })
                       .then(response => {
                       if (!response.ok) {
                           throw new Error('網路無回應....!!');
                       }
                       return response.json();
                       })
                       .then(data => {
                       if (data.success) {
                       //alert('儲存成功！');
                       //刷新頁面
                       window.location.reload();
                       } else {
                       alert('儲存失敗：' + (data.message || '未知錯誤'));
                       }
                       })
                       .catch(error => {
                       alert('發生錯誤：' + error.message);
                       //刷新頁面
                       window.location.reload();
                       });
                   }

               }


        // To display the element
        // <p class="text">您已點選<span id="count">0</span></p>

        // as a floating tooltip that follows your mouse pointer,
        //     2. Add the following JavaScript to show and move the floating element:
        // // Show the floating count tooltip
        function showFloatingCount() {
            document.getElementById('floatingCount').style.display = 'block';
        }

        // Hide the floating count tooltip
        function hideFloatingCount() {
            document.getElementById('floatingCount').style.display = 'none';
        }

        // Move the floating count tooltip with the mouse
        document.addEventListener('mousemove', function (e) {
            var tooltip = document.getElementById('floatingCount');
            if (tooltip.style.display === 'block') {
                // Offset so the tooltip doesn't cover the pointer
                tooltip.style.left = (e.clientX + 15) + 'px';
                tooltip.style.top = (e.clientY + 15) + 'px';
            }
        });

        // 3. Show/hide the tooltip as needed (for example, when hovering over positions):

        // Example: Show on mouseover, hide on mouseout for .position elements
        document.querySelectorAll('.position').forEach(function (el) {
            el.addEventListener('mouseenter', showFloatingCount);
            el.addEventListener('mouseleave', hideFloatingCount);
        });

        // 4. Update the count as you already do:
        // When updating the count, update the floating tooltip as well


        //儲存設定
        submitData.addEventListener('click', e =>{
                 openYesNoModal();
          //SubmitData();
        });


        //樓層,區別查詢
        function applyFilters() {
            var floor = document.getElementById('floor_select').value;
            var section = document.getElementById('section_select').value;
            filterPositionsByFloorAndSection(floor, section);
        }

            function filterPositionsByFloorAndSection(floor, section) {
            // var sectionNames = ["甲", "乙", "丙", "丁", "戊", "己"];
            // var sectionLabel = section !== "0" ? sectionNames[parseInt(section) - 1] + "區" : "";
            var sectionLabel=section+"區";
            document.querySelectorAll('#RootDiv_Kindness .row').forEach(row => {
                var descSpan = row.querySelector('span:last-child');
                if (!descSpan) {
                    row.style.display = 'none';
                    return;
                }
                var descText = descSpan.innerText;
                var floorMatch = (floor === "0") || descText.startsWith(floor + "樓");
                var sectionMatch = (section === "0") || descText.includes(sectionLabel);
                row.style.display = (floorMatch && sectionMatch) ? '' : 'none';
            });

             //自動關閉查詢浮動Modal
             closeQueryModal();
        }
       //樓層,區別查詢

        //目前查詢的塔位所在;

         let floor = @Html.Raw(JsonSerializer.Serialize(ViewBag.floor));
         let section = @Html.Raw(JsonSerializer.Serialize(ViewBag.section));
         // alert('floor:'+floor);
         // alert('section:'+section);
         // floor=1;
         // section=1;
        filterPositionsByFloorAndSection(floor, section);



    /* Yes / NO Modal*/

    let yesNoModalCallback = null;

    function openYesNoModal(message, callback) {
        document.getElementById('yesNoModalMessage').innerText = message || "您確定要執行此操作嗎？";
        document.getElementById('yesNoModal').style.display = 'flex';
        yesNoModalCallback = callback;
    }

    function closeYesNoModal() {
        document.getElementById('yesNoModal').style.display = 'none';
        yesNoModalCallback = null;
    }

    function yesNoModalYes() {
        if (typeof yesNoModalCallback === 'function') yesNoModalCallback(true);
        closeYesNoModal();
    }

    function yesNoModalNo() {
        if (typeof yesNoModalCallback === 'function') yesNoModalCallback(false);
        closeYesNoModal();
    }

      //顯示已進駐祖先之塔位
      populateUI();
        //   3. Call the Function After Rendering and on User Actions
        // •	After rendering positions (e.g., after populateUI()):
      //顯示塔位使用情形(空位資訊)
      updatePositionCounts();
      //顯示祖先塔位 (不能在前面執行,因為,塔位資訊尚未載入!!)




    //   2. Add a JavaScript Function to Update the Counts
    // Add this function to your <script> section:
    updatePositionCounts();

    function updatePositionCounts() {
        const allPositions = document.querySelectorAll('.position');
        //const occupiedCount = Array.from(allPositions).filter(pos => pos.classList.contains('occupied')).length;
            const occupiedCount = @Html.Raw(JsonSerializer.Serialize(ViewBag.OccupiedCount));
        const notOccupiedCount = allPositions.length - occupiedCount;
        document.getElementById('totalCount').innerText = allPositions.length;
        document.getElementById('occupiedCount').innerText = occupiedCount;
        document.getElementById('notOccupiedCount').innerText = notOccupiedCount;
    }

          // Keyboard shortcuts
        document.addEventListener('keydown', function (e) {
            if (e.key === 'T' || e.key === 't') {
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            if (e.key === 'B' || e.key === 'b') {
                e.preventDefault();
                window.history.back();
            }
        });
        document.addEventListener('keydown', function (e) {
            if (e.key === 'F1' || e.key === 'Q' || e.key === 'q') {
                e.preventDefault();
                openQueryModal();
            }
        });
        document.addEventListener('keydown', function (e) {
            if (e.key === 'S' || e.key === 's') {
                e.preventDefault();
                openYesNoModal();
            }
        });

        // Go to Top button logic
        const goTopBtn = document.getElementById('goTopBtn');
        window.addEventListener('scroll', function () {
            goTopBtn.style.display = window.scrollY > 200 ? 'block' : 'block';
        });
        goTopBtn.addEventListener('click', function () {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        });
</script>

<script type="text/javascript">
    window.AUTO_LOGOUT_MINUTES = @Html.Raw(JsonSerializer.Serialize(ViewBag.AUTO_LOGOUT_MINUTE));
    window.WARNING_BEFORE_LOGOUT_SECONDS = @Html.Raw(JsonSerializer.Serialize(ViewBag.WARNING_BEFORE_LOGOUT_SECOND));
    window.WORK_DURATION_MINUTES = @Html.Raw(JsonSerializer.Serialize(ViewBag.Work_Duration));
    window.WORK_WARNING_SECONDS = @Html.Raw(JsonSerializer.Serialize(ViewBag.WORK_WARNING_SECONDS));
</script>
<script src="~/js/AutoLogout.js" asp-append-version="true"></script>

