@model AncestralPosition
@using System.Text.Json
@{

    var builder = WebApplication.CreateBuilder();
    ViewBag.PublishDate = builder.Configuration.GetValue<string>("PublishDate");
    ViewData["Title"] = "祖先位置簡介-宗族位置查詢系統(宗族定位)";
    string? connectionString = builder.Configuration.GetConnectionString("DefaultConnection");

    // Auto logout settings
    float? AUTO_LOGOUT_MINUTE = builder.Configuration.GetSection("Logout_Duration:AUTO_LOGOUT_MINUTE").Get<float>();
    int? WARNING_BEFORE_LOGOUT_SECOND = builder.Configuration.GetSection("Logout_Duration:WARNING_BEFORE_LOGOUT_SECOND").Get<int>();

    // If AUTO_LOGOUT_MINUTE or WARNING_BEFORE_LOGOUT_SECOND is not set, use default values
    if (AUTO_LOGOUT_MINUTE == null || WARNING_BEFORE_LOGOUT_SECOND == null)
    {
        // Default values if not set in configuration
        AUTO_LOGOUT_MINUTE = (float?)0.5; // 30 minutes
        WARNING_BEFORE_LOGOUT_SECOND = 10; // 10 seconds
    }
    else
        // Set ViewBag for use in the view
        ViewBag.AUTO_LOGOUT_MINUTE = AUTO_LOGOUT_MINUTE;
    ViewBag.WARNING_BEFORE_LOGOUT_SECOND = WARNING_BEFORE_LOGOUT_SECOND;

    // Work_Duration is used for the duration of work in the system
    float? Work_Duration = builder.Configuration.GetSection("Work_Duration").Get<float>();
    int? WORK_WARNING_SECONDS = builder.Configuration.GetSection("WORK_WARNING_SECONDS").Get<int>();

    // If Work_Duration is not set, use default value
    if (Work_Duration == null)
    {
        // Default value if not set in configuration
        Work_Duration = (float?)1.0; // 1 mins
    }
    ViewBag.Work_Duration = Work_Duration;
    // Set ViewBag for WORK_WARNING_SECONDS for use in the view
    if (WORK_WARNING_SECONDS == null)
    {
        // Default value if not set in configuration
        WORK_WARNING_SECONDS = 60; // 60 seconds
    }
    ViewBag.WORK_WARNING_SECONDS = WORK_WARNING_SECONDS; // Default value will be null if not set
}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- 引入CSS樣式表 -->
    <link rel="stylesheet" href="~/css/position_Display.css" asp-append-version="true" />
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <title>宗族-位置查詢</title>
</head>

<body>
    <header>
        <div id="txtblnkindex1" class="text-center fw-bolder blink">
            <p id="work_duration_top" style="font-size:larger;color:green;font-weight:bolder" class="text-bg-info align-content-center fw-bolder"></p>
        </div>
    </header>
    <a asp-action="PositionQuery" class="btn btn-outline-primary bg-gradient mb-5 fw-semibold  text-uppercase">
        <label style="font-size:30px;color:darkgreen;font-weight:bolder">返回</label>
    </a>
    <h2>宗族-位置</h2>
    <div class="card-body p-4">
        <label>名稱</label>
        <label id="Ancestral_Name" class="displaylabel blink_name">@Model.Name</label>
        <label id="Ancestral_PositionId" class="displaylabel blink_name">@Model.PositionId</label>
    @*     <label id="Ancestral_Applicant">申請人:@Model.Applicant</label> *@
        <label></label>
    </div>
    <h2>祖先 側,區</h2>
    <div>
        <div id="RootDiv_Ancestral_layout" class="position-container-Ancestral-layout"></div>
    </div>

    <div>
        <div id="RootDiv_Ancestral_left" class="position-container-Ancestral-left"></div>
    </div>
    <div>
        <div id="RootDiv_Ancestral_right" class="position-container-Ancestral-right"></div>
    </div>

    <div id="queryModal" class="modal-overlay" style="display:none;">
        <div class="modal-content">
            <span class="close-btn" onclick="closeQueryModal()">&times;</span>
            <h3><span class="blink_name" id="ModalName"></span></h3>
            <h3><span class="blink_name" id="ModalPositionId"></span></h3>
            @*  <h5><span id="ModalApplicant"></span></h5>    *@     
            <div id="ModalDynamicContent">
                <!-- Dynamic content will be injected here -->
            </div>
            <!-- ...other modal content... -->
        </div>
    </div>

    @* Message Modal 2025 07 15 12:42 *@
    <div id="MseModal" class="modal-overlay" style="display:none;">
        <span class="close-btn" onclick="closeMsgModal()">&times;</span>
        <div class="modal-content yesno-modal">
            <h2 id="MsgModalTitle" class="yesno-title">訊息</h2>
            <p id="MsgModalMessage" class="yesno-message"></p>
        </div>
    </div>
    <h2>宗族位置配置圖示</h2>
    <div class="col-12 text-center fw-bolder">
        <img src="~/images/Ancestral/Ancestral_layout_1.jpg" alt="位置圖" style="max-width:100%;height:auto;" />
    </div>
    <div class="col-12 text-center fw-bolder">
        <img src="~/images/Ancestral/Ancestral_note_1.jpg" alt="位置配置說明" style="max-width:100%;height:auto;" />
    </div>
    <div class="col-12 text-center fw-bolder">
        <img src="~/images/Ancestral/Ancestral_note_0.jpg" alt="位置查詢說明" style="max-width:100%;height:auto;" />
    </div>

    <div id="autoLogoutWarning">
        <div class="modal-content">
            <h4 style="color:#c0392b;">自動登出警告[系統提示]......</h4>
            <p style="color:blue;font-size:xx-large;font-weight:bolder">系統即將自動登出您的帳戶,請於 <span style="color:red;font-size:larger" id="logoutCountdown">@ViewBag.WARNING_BEFORE_LOGOUT_SECOND</span> 秒內確認操作[繼續工作](ADP)?</p>
            <button onclick="stayLoggedIn()" class="btn btn-primary">[繼續工作]</button>
        </div>
    </div>
    <button id="goTopBtn" class="btn btn-danger">返回頂部</button>
    <div id="workDurationWarning" style="display:none; position:fixed; left:0; top:0; width:100vw; height:100vh; background:rgba(0,0,0,0.3); z-index:9999; align-items:center; justify-content:center;">
        <div class="modal-content" style="background:#fff; padding:2rem 2.5rem; border-radius:10px; box-shadow:0 4px 24px rgba(0,0,0,0.18); text-align:center; max-width:90vw;">
            <p style="color:blue;font-size:xx-large;font-weight:bolder">系統工作時間即將超時,請於 <span style="color:red;font-size:larger" id="workLogoutCountdown">@ViewBag.WORK_WARNING_SECONDS</span> 秒內完成您的操作,否則將自動登出[重新登入][繼續工作](ADP)?</p>
        </div>
    </div>
</body>
</html>
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script>


        //////////////////////////
        //0.祖先 側,區,層配置清單
        // (說明) r代表 右側 位置
            ////////////////////////////
            // 說明: 佈局與位置初始化 (側 / 區 / 層 / 位置)
            ///////////////////////////
         // 左側配置清單:側,區,層,位置數
        var allayout=@Html.Raw(JsonSerializer.Serialize<object>(ViewBag.AncestralLayout_L));
         // 配置/配置清單:側,區,層,位置數,備註配置,側,區,層,位置
        var alayout=@Html.Raw(JsonSerializer.Serialize<object>(ViewBag.AncestralLayout));

        //////////////////////////
        //1.右側位置行數據 (層級)
        // (說明) r代表 右側 位置
        /////////////////////////
        // 層級 1到10行:
        // 右側行1配置數據
        var ararow1 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ararow1));
        // 右側行2配置
        var ararow2 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ararow2));
        // 右側行3配置
        var ararow3 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ararow3));
        // 右側行4配置
        var ararow4 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ararow4));
        // 右側行5配置
        var ararow5 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ararow5));
        // 右側行6配置
        var ararow6 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ararow6));
        // 右側行7配置
        var ararow7 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ararow7));
        // 右側行8配置
        var ararow8 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ararow8));
        // 右側行9配置
                        let position=row[j]; // position id in this cell
                        let positionId = desc+rowId+"層:" + position;  // eg: 側-區-7層:34  format:側-區-層:位置
        var ararow10 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ararow10));

        // 右側 B 行1配置
        var arbrow1 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arbrow1));
        // 右側 B 行2配置
        var arbrow2 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arbrow2));
        // 右側 B 行3配置
        var arbrow3 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arbrow3));
        // 右側 B 行4配置
        var arbrow4 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arbrow4));
        // 右側 B 行5配置
        var arbrow5 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arbrow5));
        // 右側 B 行6配置
        var arbrow6 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arbrow6));
        // 右側 B 行7配置
        var arbrow7 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arbrow7));
        // 右側 B 行8配置
        var arbrow8 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arbrow8));
        // 右側 B 行9配置
        var arbrow9 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arbrow9));
        // 右側 B 行10配置
        var arbrow10 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arbrow10));

        // C 區行配置 (1-10)
        // 行1配置
        var arcrow1 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arcrow1));
        // 行2配置
        var arcrow2 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arcrow2));
        // 行3配置
        var arcrow3 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arcrow3));
        // 行4配置
        var arcrow4 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arcrow4));
        // 行5配置
        var arcrow5 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arcrow5));
        // 行6配置
        var arcrow6 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arcrow6));
        // 行7配置
        var arcrow7 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arcrow7));
        // 行8配置
        var arcrow8 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arcrow8));
        // 行9配置
        var arcrow9 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arcrow9));
        // 行10配置
        var arcrow10 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.arcrow10));

        // D 區行配置 (1-10)
        // 行1配置
        var ardrow1 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ardrow1));
        // 行2配置
        var ardrow2 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ardrow2));
        // 行3配置
        var ardrow3 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ardrow3));
        // 行4配置
        var ardrow4 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ardrow4));
        // 行5配置
        var ardrow5 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ardrow5));
        // 行6配置
        var ardrow6 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ardrow6));
        // 行7配置
        var ardrow7 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ardrow7));
        // 行8配置
        var ardrow8 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ardrow8));
        // 行9配置
        var ardrow9 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ardrow9));
        // 行10配置
        var ardrow10 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ardrow10));

        //2025 08 26 14:27
        // M 區行配置 (1-10)
        // 行1配置
        var armrow1 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.armrow1));
        // 行2配置
        var armrow2 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.armrow2));
        // 行3配置
        var armrow3 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.armrow3));
        // 行4配置
        var armrow4 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.armrow4));
        // 行5配置
        var armrow5 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.armrow5));
        // 行6配置
        var armrow6 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.armrow6));
        // 行7配置
        var armrow7 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.armrow7));
        // 行8配置
        var armrow8 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.armrow8));
        // 行9配置
        var armrow9 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.armrow9));
        // 行10配置
        var armrow10 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.armrow10));
         //////////////////////////
        // 3. 左側行數據 (層級)
        // (說明) l代表 左側 位置
        /////////////////////////
        // 左側 A 區行配置 (1-10)
        // 行1配置
        var alarow1 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alarow1));
        // 行2配置
        var alarow2 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alarow2));
        // 行3配置
        var alarow3 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alarow3));
        // 行4配置
        var alarow4 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alarow4));
        // 行5配置
        var alarow5 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alarow5));
        // 行6配置
        var alarow6 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alarow6));
        // 行7配置
        var alarow7 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alarow7));
        // 行8配置
        var alarow8 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alarow8));
        // 行9配置
        var alarow9 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alarow9));
        // 行10配置
        var alarow10 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alarow10));

        // 左側 B 區行配置 (1-10)
        // 行1配置
        var albrow1 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.albrow1));
        // 行2配置
        var albrow2 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.albrow2));
        // 行3配置
        var albrow3 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.albrow3));
        // 行4配置
        var albrow4 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.albrow4));
        // 行5配置
        var albrow5 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.albrow5));
        // 行6配置
        var albrow6 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.albrow6));
        // 行7配置
        var albrow7 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.albrow7));
        // 行8配置
        var albrow8 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.albrow8));
        // 行9配置
        var albrow9 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.albrow9));
        // 行10配置
        var albrow10 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.albrow10));

        // 左側 C 區行配置 (1-10)
        // 行1配置
        var alcrow1 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alcrow1));
        // 行2配置
        var alcrow2 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alcrow2));
        // 行3配置
        var alcrow3 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alcrow3));
        // 行4配置
        var alcrow4 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alcrow4));
        // 行5配置
        var alcrow5 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alcrow5));
        // 行6配置
        var alcrow6 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alcrow6));
        // 行7配置
        var alcrow7 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alcrow7));
        // 行8配置
        var alcrow8 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alcrow8));
        // 行9配置
        var alcrow9 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alcrow9));
        // 行10配置
        var alcrow10 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.alcrow10));

        // 左側 D 區行配置 (1-10)
        // 行1配置
        var aldrow1 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.aldrow1));
        // 行2配置
        var aldrow2 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.aldrow2));
        // 行3配置
        var aldrow3 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.aldrow3));
        // 行4配置
        var aldrow4 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.aldrow4));
        // 行5配置
        var aldrow5 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.aldrow5));
        // 行6配置
        var aldrow6 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.aldrow6));
        // 行7配置
        var aldrow7 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.aldrow7));
        // 行8配置
        var aldrow8 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.aldrow8));
        // 行9配置
        var aldrow9 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.aldrow9));
        // 行10配置
        var aldrow10 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.aldrow10));

        //2025 08 26 14:27
        // M 右側行群 (1-10)
        // 行1配置
        var almrow1 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.almrow1));
        // 行2配置
        var almrow2 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.almrow2));
        // 行3配置
        var almrow3 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.almrow3));
        // 右側 M 區: 行4-10 配置資料 (來源: ViewBag.almrowX)
        var almrow4 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.almrow4));
        var almrow5 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.almrow5));
        var almrow6 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.almrow6));
        var almrow7 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.almrow7));
        var almrow8 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.almrow8));
        var almrow9 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.almrow9));
        var almrow10 = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.almrow10));

        //////////////////////////////
        // 4. 左側位置二維數組配置
        /////////////////////////////

        // 左側 A 區行,列~ 行 位置二維配置
        var positionary_alaary = Array.from({ length: @(ViewBag.lar ?? 0) }, () => Array(@(ViewBag.lac ?? 0)).fill(0));
        // 說明: 左側 A 區位置陣列初始化 (將每列字串拆分為位置陣列)
            // 左側 A 區行,列 位置二維配置
            positionary_alaary[0] = alarow1.split(",");
            positionary_alaary[1] = alarow2.split(",");
            positionary_alaary[2] = alarow3.split(",");
            positionary_alaary[3] = alarow4.split(",");
            positionary_alaary[4] = alarow5.split(",");
            positionary_alaary[5] = alarow6.split(",");
            positionary_alaary[6] = alarow7.split(",");
            positionary_alaary[7] = alarow8.split(",");
            positionary_alaary[8] = alarow9.split(",");
            positionary_alaary[9] = alarow10.split(",");

        /// 說明: 左側 B 區位置二維陣列初始化
        var positionary_albary = Array.from({ length: @(ViewBag.lbr ?? 0) }, () => Array(@(ViewBag.lbc ?? 0)).fill(0));
        // 初始化: 將每列字串拆分為位置陣列 (來源: ViewBag)
            positionary_albary[0] = albrow1.split(",");
            positionary_albary[1] = albrow2.split(",");
            positionary_albary[2] = albrow3.split(",");
            positionary_albary[3] = albrow4.split(",");
            positionary_albary[4] = albrow5.split(",");
            positionary_albary[5] = albrow6.split(",");
            positionary_albary[6] = albrow7.split(",");
            positionary_albary[7] = albrow8.split(",");
            positionary_albary[8] = albrow9.split(",");
            positionary_albary[9] = albrow10.split(",");

        /// 說明: 左側 C 區位置二維陣列初始化
        var positionary_alcary = Array.from({ length: @(ViewBag.lcr ?? 0) }, () => Array(@(ViewBag.lcc ?? 0)).fill(0));
        // 初始化: 將每列字串拆分為位置陣列 (來源: ViewBag)
            positionary_alcary[0] = alcrow1.split(",");
            positionary_alcary[1] = alcrow2.split(",");
            positionary_alcary[2] = alcrow3.split(",");
            positionary_alcary[3] = alcrow4.split(",");
            positionary_alcary[4] = alcrow5.split(",");
            positionary_alcary[5] = alcrow6.split(",");
            positionary_alcary[6] = alcrow7.split(",");
            positionary_alcary[7] = alcrow8.split(",");
            positionary_alcary[8] = alcrow9.split(",");
            positionary_alcary[9] = alcrow10.split(",");

        /// 說明: 左側 D 區位置二維陣列初始化
        var positionary_aldary = Array.from({ length: @(ViewBag.ldr ?? 0) }, () => Array(@(ViewBag.ldc ?? 0)).fill(0));
        // 初始化: 將每列字串拆分為位置陣列 (來源: ViewBag)
            positionary_aldary[0] = aldrow1.split(",");
            positionary_aldary[1] = aldrow2.split(",");
            positionary_aldary[2] = aldrow3.split(",");
            positionary_aldary[3] = aldrow4.split(",");
            positionary_aldary[4] = aldrow5.split(",");
            positionary_aldary[5] = aldrow6.split(",");
            positionary_aldary[6] = aldrow7.split(",");
            positionary_aldary[7] = aldrow8.split(",");
            positionary_aldary[8] = aldrow9.split(",");
            positionary_aldary[9] = aldrow10.split(",");

        //2025 08 26 14:28
        /// 說明: 左側 M 區位置二維陣列初始化
        var positionary_almary = Array.from({ length: @(ViewBag.lmr ?? 0) }, () => Array(@(ViewBag.lmc ?? 0)).fill(0));
        // 初始化: 將每列字串拆分為位置陣列 (來源: ViewBag)
            positionary_almary[0] = almrow1.split(",");
            positionary_almary[1] = almrow2.split(",");
            positionary_almary[2] = almrow3.split(",");
            positionary_almary[3] = almrow4.split(",");
            positionary_almary[4] = almrow5.split(",");
            positionary_almary[5] = almrow6.split(",");
            positionary_almary[6] = almrow7.split(",");
            positionary_almary[7] = almrow8.split(",");
            positionary_almary[8] = almrow9.split(",");
            positionary_almary[9] = almrow10.split(",");

         /// 說明: 右側 A 區位置二維陣列初始化
         var positionary_araary = Array.from({ length: @(ViewBag.rar ?? 0) }, () => Array(@(ViewBag.rac ?? 0)).fill(0));
     // 初始化: 將每列字串拆分為位置陣列 (來源: ViewBag)
    positionary_araary[0] = ararow1.split(",");
    positionary_araary[1] = ararow2.split(",");
    positionary_araary[2] = ararow3.split(",");
    positionary_araary[3] = ararow4.split(",");
    positionary_araary[4] = ararow5.split(",");
    positionary_araary[5] = ararow6.split(",");
    positionary_araary[6] = ararow7.split(",");
    positionary_araary[7] = ararow8.split(",");
    positionary_araary[8] = ararow9.split(",");
    positionary_araary[9] = ararow10.split(",");
        // 初始化: 第10列位置
        positionary_araary[9] = ararow10.split(",");

        /// 說明: 右側 B 區位置二維陣列初始化
        var positionary_arbary = Array.from({ length: @(ViewBag.rbr ?? 0) }, () => Array(@(ViewBag.rbc ?? 0)).fill(0));

        // 初始化: 各列位置設定 (來源: ViewBag)
        positionary_arbary[0] = arbrow1.split(",");
        positionary_arbary[1] = arbrow2.split(",");
        positionary_arbary[2] = arbrow3.split(",");
        positionary_arbary[3] = arbrow4.split(",");
        positionary_arbary[4] = arbrow5.split(",");
        positionary_arbary[5] = arbrow6.split(",");
        positionary_arbary[6] = arbrow7.split(",");
        positionary_arbary[7] = arbrow8.split(",");
        positionary_arbary[8] = arbrow9.split(",");
        positionary_arbary[9] = arbrow10.split(",");

        /// 說明: 右側 C 區位置二維陣列初始化
        var positionary_arcary = Array.from({ length: @(ViewBag.rcr ?? 0) }, () => Array(@(ViewBag.rcc ?? 0)).fill(0));
        // 初始化: 各列位置設定 (來源: ViewBag)
        positionary_arcary[0] = arcrow1.split(",");
        positionary_arcary[1] = arcrow2.split(",");
        positionary_arcary[2] = arcrow3.split(",");
        positionary_arcary[3] = arcrow4.split(",");
        positionary_arcary[4] = arcrow5.split(",");
        positionary_arcary[5] = arcrow6.split(",");
        positionary_arcary[6] = arcrow7.split(",");
        positionary_arcary[7] = arcrow8.split(",");
        positionary_arcary[8] = arcrow9.split(",");
        positionary_arcary[9] = arcrow10.split(",");

        /// 說明: 右側 D 區位置二維陣列初始化
        var positionary_ardary = Array.from({ length: @(ViewBag.rdr ?? 0) }, () => Array(@(ViewBag.rdc ?? 0)).fill(0));
        // 初始化: 各列位置設定 (來源: ViewBag)
        positionary_ardary[0] = ardrow1.split(",");
        positionary_ardary[1] = ardrow2.split(",");
        positionary_ardary[2] = ardrow3.split(",");
        positionary_ardary[3] = ardrow4.split(",");
        positionary_ardary[4] = ardrow5.split(",");
        positionary_ardary[5] = ardrow6.split(",");
        positionary_ardary[6] = ardrow7.split(",");
        positionary_ardary[7] = ardrow8.split(",");
        positionary_ardary[8] = ardrow9.split(",");
        positionary_ardary[9] = ardrow10.split(",");

        //2025 08 26 14:28
        /// 說明: 右側 M 區位置二維陣列初始化
        var positionary_armary = Array.from({ length: @(ViewBag.rmr ?? 0) }, () => Array(@(ViewBag.rmc ?? 0)).fill(0));
        // 初始化: 各列位置設定 (來源: ViewBag)
        positionary_armary[0] = armrow1.split(",");
        positionary_armary[1] = armrow2.split(",");
        positionary_armary[2] = armrow3.split(",");
        positionary_armary[3] = armrow4.split(",");
        positionary_armary[4] = armrow5.split(",");
        positionary_armary[5] = armrow6.split(",");
        positionary_armary[6] = armrow7.split(",");
        positionary_armary[7] = armrow8.split(",");
        positionary_armary[8] = armrow9.split(",");
        positionary_armary[9] = armrow10.split(",");


        // 初始化: 佈局陣列 (來源: 2025-07-12 13:14)
        var alayout_ary = Array.from({ length: @(ViewBag.AncestralSide ?? 0) }, () => Array(@(ViewBag.AncestralSection ?? 0)).fill(0));
        // 設定: 左側佈局資料 (來源: 2025-07-12 13:14)
        alayout_ary[0] = allayout.split(",");
        // 設定: 右側佈局資料 (來源: 2025-07-12 13:14)
        alayout_ary[1] = arlayout.split(",");

        // 另一組初始化（歷史遺留）: 佈局陣列（來源: 2025-07-12 13:14）
        var alayout_ary = Array.from({ length: @(ViewBag.AncestralSide - 1 ?? 0) }, () => Array(@(ViewBag.AncestralSection * 2 ?? 0)).fill(0));
        // 設定: 佈局字串分割為陣列
        alayout_ary[0] = alayout.split(",");

          ////////////////////////////
          // 佈局渲染區塊說明
          ////////////////////////////

          /////////////////////////
          /// 說明: 區段與側邊位置渲染
          /////////////////////////

              /////////////////////////
          /// 說明: 左右側與區段的配置說明
          /////////////////////////
          // (1) 左右側示意
          // l: 左側 (left)
          //===============
          // r: 右側 (right)

         //2025 08 26 14:28
         // M區-左側:
        var desc="M區-左側-";
        renderPositionRows("RootDiv_Ancestral_left",positionary_almary,desc,'levelleft','positionAncestral');

        // A區-左側:
        desc="A區-左側-";
        renderPositionRows("RootDiv_Ancestral_left",positionary_alaary,desc,'levelleft','positionAncestral');

         // B區-左側:
        desc="B區-左側-";
        renderPositionRows("RootDiv_Ancestral_left",positionary_albary,desc,'levelleft','positionAncestral');

          // C區-左側:
        desc="C區-左側-";
        renderPositionRows("RootDiv_Ancestral_left",positionary_alcary,desc,'levelleft','positionAncestral');


        // D區-左側:
        desc="D區-左側-";
        renderPositionRows("RootDiv_Ancestral_left",positionary_aldary,desc,'levelleft','positionAncestral');

        /////////////////////////
        // 右側位置配置
        /////////////////////////
        //2025 08 26 14:28
        // M區-右側:
        var desc="M區-右側-";
        renderPositionRows("RootDiv_Ancestral_right",positionary_armary,desc,'levelleft','positionAncestral')

        // A區-右側:
        desc="A區-右側-";
        renderPositionRows("RootDiv_Ancestral_right",positionary_araary,desc,'levelright','positionAncestral');

        // B區-右側:
        desc="B區-右側-";
        renderPositionRows("RootDiv_Ancestral_right",positionary_arbary,desc,'levelright','positionAncestral');

        // C區-右側:
        desc="C區-右側-";
        renderPositionRows("RootDiv_Ancestral_right",positionary_arcary,desc,'levelright','positionAncestral');

        // D區-右側:
        desc="D區-右側-";
        renderPositionRows("RootDiv_Ancestral_right",positionary_ardary, desc,'levelright','positionAncestral');


         // 說明: 渲染側與區段 (參數: root_div, positionary_asideary)
        // 參數解釋: positionary_asideary 為每個區段的名稱或位置集合
         function renderLayoutSideSection(root_div,positionary_asideary,desc,levelClassName,positionClassName)
        {
               // alert('desc : '+desc);
               // alert('root_div : '+root_div);
               // alert('positionary_asideary : '+positionary_asideary);
               // alert('levelClassName : '+levelClassName);
            let sideDiv= document.createElement('div');
               // 設定 CSS class 為 row
            sideDiv.className = 'row';
            for (let i =0; i <= positionary_asideary.length-1 ; i++) {
                    //??
                    let  section = positionary_asideary[i];
                    // 建立區段 span 並設定顯示文字與樣式
                    let SectionSpan = document.createElement('span');
                    SectionSpan.readOnly = true // 設為唯讀
                    SectionSpan.innerText = section;   // 設定區段文字，例如: A區, B區
                    SectionSpan.className = positionClassName; // 設定 span 的 class 為位置樣式
                    // 將 span 加入 row 容器
                    sideDiv.appendChild(SectionSpan);
                }
                // 建立並加入層級描述的 span（預留位置，現為註解）
                    // 若需要，可在此加入層級描述的 span（目前註解）
                    // let descSpan = document.createElement('span');
                    // descSpan.readOnly = true // 設為唯讀
                    // descSpan.className = levelClassName; // 設定層級樣式
                    // descSpan.innerText = desc; // 顯示區段描述
                     // 將 descSpan 加入 sideDiv（目前保留為註解）
                    //sideDiv.appendChild(descSpan);
                // Add the row div to the container
                // 將 sideDiv 加入指定容器 (root_div)
                document.getElementById(root_div).appendChild(sideDiv);
         }

        // 說明: 渲染每列位置 (參數: root_div, positionary_asideary, desc, levelClassName, positionClassName)
        // 參數解釋: positionary_asideary 為每列的位置陣列 (每列為一個位置陣列)
         function renderPositionRows(root_div,positionary_asideary,desc,levelClassName,positionClassName) {
            //Get each Row ID
            let rowId = "";
            for (let i =0; i <= positionary_asideary.length-1 ; i++) {
                //Get each Row ID
                rowId = (i+1)
                // Get each row of position IDs
                // 取得該列的位置陣列
                let row = positionary_asideary[i];
                  // Create a div for the row
                  // 建立 row 容器 div
                  let rowDiv = document.createElement('div');
                  // 設定 container class 為 row
                rowDiv.className = 'row';
                for (let j=0; j <= row.length-1;j++) {
                    // Get each position ID
                      // 取得單一位置代碼
                      let position=row[j]; // 單一位置代碼
                    let positionId = desc+rowId+"層:" + position;  //eg:??-??-7:34  format:側-區-層:?
                    // Create a span for the position
                      // 建立位置顯示用的 span
                    let positionSpan = document.createElement('span');
                      positionSpan.readOnly = true // 設為唯讀
                    if (position==="000")
                    {
                           positionSpan.className = 'position_window_door';
                           positionSpan.innerText = '空位';
                    }
                    else
                    {
                          positionSpan.className = positionClassName; // 設定位置 span 的 class
                           positionSpan.innerText = positionId; // 設定顯示文字 (例如: 側-區-層:位置)
                    }

                    // Add the span to the row div
                    // 將 position span 加入 rowDiv
                    rowDiv.appendChild(positionSpan);
                }
                // 建立並加入層級標示的 span
                    let positionSpan = document.createElement('span');
                    positionSpan.readOnly = true // 設為唯讀
                    positionSpan.className = levelClassName; // 設定層級樣式
                    positionSpan.innerText = desc.replace("\n","") +(i+1)+"層"; // 層級標示
                    rowDiv.appendChild(positionSpan);
                // Add the row div to the container
                // 將該列加入指定的容器（root_div）
                document.getElementById(root_div).appendChild(rowDiv);
            }
        }


          //(1) find the Section for the wanted clan
        function populateSectionUI() {

            const positions = document.querySelectorAll('.sectionAncestral');
            var section = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.section)); /// 從 ViewBag 取得指定區段
            //alert('section: '+section);
                if(section.length > 0) {
                    positions.forEach(position => {
                        var  bool_result= (section+"區")==position.innerText;;/// 比對是否為指定區
                        //alert('bool_result: ' +bool_result);
                        if (bool_result) {
                            position.classList.add('Ancestralsectioncurrent');/// 標示為目前區段
                            position.classList.add('blink'); // 設為閃爍以便顯示
                            // 若需要，可將 PositionId 加到文字顯示上
                            //position.innerText += ('-'+ @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.PositionId)));
                            }
                    });
                    }
                }


         //(1) populate position from Database to UI  sectionAncestral
        function populateUI() {

            const positions = document.querySelectorAll('.positionAncestral');
            //alert('positions.length: '+positions.length);

                /// 取得 ViewBag.ListPositionId
            var listPositionId = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.ListPositionId));
            //alert('listPositionId.length: '+listPositionId.length);
                if(listPositionId.length > 0) {
                    //alert('kind==1');
                    //alert('ListPositionId: ' + JSON.stringify(listPositionId));
                    positions.forEach(position => {
                        listPositionId.forEach(positionid => {  /// 逐一比較資料庫回傳的已佔位置
                        var  Local_positionid=position.innerText;
                        // 取得資料庫位置字串的 id 部分
                        var  positionId_compared=positionid.substr(0,positionid.indexOf(","));  // 取出 '側-區-層:位置' 部分
                        var  name=positionid.substr(positionid.indexOf(",")+1);  // 取出姓名
                        var  bool_result=positionId_compared===Local_positionid; // 比對是否相符
                          // 目前使用者選取的 PositionId
                        var currentPositonId=  @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.PositionId));
                        if (bool_result) {
                            position.classList.add('occupied'); // 標示為已佔用
                            position.innerText += ('-'+ name);
                             if (currentPositonId === Local_positionid) // 若為目前選中的位置
                              {
                                 position.classList.add('current'); // 標示為目前位置
                                 position.classList.add('blink');// 設為閃爍顯示
                                 var  sideSectionLevel=positionid.substr(0,positionid.indexOf(":"));  // 取出側/區/層前段
                                 var targetSpan = findSpanByInnerText(sideSectionLevel);
                                     if (targetSpan) {
                                         targetSpan.classList.add('blink');// 讓對應區段閃爍
                                    }
                              }
                            }
                        });
                    });
                }
       }


       function findSpanByInnerText(sideSectionLevel) {
        // 2025 08 01 00:18 Get all spans (or use a more specific selector if needed)
        const spans = document.querySelectorAll('span');
        // Find the first span whose innerText matches floorSectionLevel exactly
        for (let span of spans) {
            if (span.innerText.trim() === sideSectionLevel.trim()) {
                return span;
            }
        }
        return null; // Not found
       }

          // 正規化: 處理側/區的標記
        function filterPositionsBySideAndSection(side, section) {
        // Normalize for "??"
        const allSides = (side === "0");
        const allSections = (section === "0");

        // Build label for matching
        const sideLabel = allSides ? "" : side + "側";
        const sectionLabel = allSections ? "" : section + "區";

         // 2025 07 15 01:43 Count right side positions fitted to [sideLabel] && [sectionLabel]:
            var PositionsFitted_count=0;
            const positions = document.querySelectorAll('.positionAncestral');
            positions.forEach(position=>{
                const descText = position.innerText;
                const sideMatch = allSides || descText.startsWith(sideLabel);
                const sectionMatch = allSections || descText.includes(sectionLabel);
                if(sideMatch && sectionMatch)
                {
                    PositionsFitted_count++;
                }
             });
             //alert('PositionsFitted_count:'+PositionsFitted_count);
            // Count right side positions fitted to [sideLabel] && [sectionLabel]:

                if (PositionsFitted_count==0)
            {
               openMsgModal("提示：未找到符合條件的塔位 (側:"+ side +", 區:"+ section +")。請檢查設定或資料來源。 建議：(1) 檢查側/區設定；(2) 檢查佈局資料。");
                // 2025 07 15 09:31 make Button 'displayWantedSideSecBtn' invisible
                document.getElementById('displayWantedSideSecBtn').style.display = 'none';
            }
            else
            {
                // Filter left side
                document.querySelectorAll('#RootDiv_Ancestral_left .row').forEach(row => {
                    const descSpan = row.querySelector('span:last-child');
                    if (!descSpan) {
                        row.style.display = 'none';
                        return;
                    }
                    const descText = descSpan.innerText;
                    const sideMatch = allSides || descText.startsWith(sideLabel);
                    const sectionMatch = allSections || descText.includes(sectionLabel);
                    row.style.display = (sideMatch && sectionMatch) ? '' : 'none';
                });

                // Filter right side
                document.querySelectorAll('#RootDiv_Ancestral_right .row').forEach(row => {
                    const descSpan = row.querySelector('span:last-child');
                    if (!descSpan) {
                        row.style.display = 'none';
                        return;
                    }
                    const descText = descSpan.innerText;
                    const sideMatch = allSides || descText.startsWith(sideLabel);
                    const sectionMatch = allSections || descText.includes(sectionLabel);
                    row.style.display = (sideMatch && sectionMatch) ? '' : 'none';
                });

                                /*2025-07-18: 將某些元素高度調整為較高 (調整顯示優先)*/
                desc="側-區,層";
                renderLayoutSideSection("RootDiv_Ancestral_layout", alayout_ary[0],desc,'levelleft','sectionAncestral');

                /*2025-07-18: 將某些元素高度調整為較高層級 (調整顯示優先順序)*/
                MakeFirstClanHigher();

                //alert(displayed_positionid)
                //Dispaly wanted side &section info
                openQueryModalWithData();
        }
    }

    /// 說明: 取得篩選條件 (側/區)

    let side = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.side));
    let section = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.section));
    filterPositionsBySideAndSection(side, section);

     /// 執行: 將資料顯示到 UI
     populateUI();
     /// 初始化完成

      //(1) find the Section for the wanted clan
      populateSectionUI();

      //Display Result onto a Modal windows 2025 07 11 16:01

        function openQueryModalWithData() {
                var displayed_section = document.getElementById('RootDiv_Ancestral_layout').innerHTML;
                    // 取得 modal 要顯示的內容
        var name = document.getElementById('Ancestral_Name').innerHTML;
        var positionId = document.getElementById('Ancestral_PositionId').innerHTML;
        //var applicant=document.getElementById('Ancestral_Applicant').innerHTML;
        //var cyfiedName = name.substr(0,1)+"*"+name.substr(2,10);
        //Example: data could be an object or string
        document.getElementById('ModalDynamicContent').innerHTML =
            `<p style="text-align:center">${displayed_section}</p>`;
        document.getElementById('ModalName').innerHTML =
            `<p style="font-size:30px;font-weight:bolder">${name}</p>`;
        document.getElementById('ModalPositionId').innerHTML =
            `<p style="font-size:30px;font-weight:bolder">${positionId}</p>`;
        // document.getElementById('ModalApplicant').innerHTML =
        //     `<p style="font-size:10px;font-weight:bolder">${applicant}</p>`;
        //visable: block
        document.getElementById('queryModal').style.display = 'block';
    }
        function closeQueryModal() {
        //invisable: none
        document.getElementById('queryModal').style.display = 'none';
    }

    //2025 07 15 09:18 open Message Modal
    function openMsgModal(message) {
        document.getElementById('MsgModalMessage').innerText = message;
        document.getElementById('MseModal').style.display = 'flex';
    }

    //2025 07 15 09:18 close Message Modal
    function closeMsgModal() {
        document.getElementById('MseModal').style.display = 'none';
    }



    /*2025-07-18: 將某些元素高度調整為較高 (調整顯示優先)*/
    function MakeFirstClanHigher() {
        const container = document.getElementById('RootDiv_Ancestral_layout');
        const spans = container.querySelectorAll('span');
        spans.forEach(span => {
            if (span.innerText.trim() === "上") {   /// 祖先標記
                // Found!
                span.classList.add('position-ancestor-layout');
                //span.classList.add('blink_firstMan'); // ?? 2025 07 31 00:01
            }
        });
    }

      // Keyboard shortcuts
    document.addEventListener('keydown', function (e) {
        if (e.key === 'T' || e.key === 't') {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
        if (e.key === 'B' || e.key === 'b') {
            e.preventDefault();
            window.history.back();
        }
    });
    // document.addEventListener('keydown', function (e) {
    //     if (e.key === 'F1' || e.key === 'Q' || e.key === 'q') {
    //         e.preventDefault();
    //         openQueryModal();
    //     }
    // });
    // document.addEventListener('keydown', function (e) {
    //     if (e.key === 'S' || e.key === 's') {
    //         e.preventDefault();
    //         openYesNoModal();
    //     }
    // });

    // Go to Top button logic
    const goTopBtn = document.getElementById('goTopBtn');
    window.addEventListener('scroll', function () {
        goTopBtn.style.display = window.scrollY > 200 ? 'block' : 'block';
    });
    goTopBtn.addEventListener('click', function () {
        window.scrollTo({ top: 0, behavior: 'smooth' });
    });

</script>

<script type="text/javascript">
    window.AUTO_LOGOUT_MINUTES = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.AUTO_LOGOUT_MINUTE));
    window.WARNING_BEFORE_LOGOUT_SECONDS = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.WARNING_BEFORE_LOGOUT_SECOND));
    window.WORK_DURATION_MINUTES = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.Work_Duration));
    window.WORK_WARNING_SECONDS = @Html.Raw(JsonSerializer.Serialize<object>(ViewBag.WORK_WARNING_SECONDS));
</script>
<script src="~/js/AutoLogout.js" asp-append-version="true"></script>



